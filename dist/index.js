(()=>{var g=class{constructor(t,e,i,r){this.r=t,this.g=e,this.b=i,this.a=r}},x=class{constructor(){this.scaleX=1,this.scaleY=1,this.offsetX=0,this.offsetY=0,this.loop=!1,this._vbuffer=0,this._coord=0,this.visible=!0,this.intensity=1,this.xy=new Float32Array([]),this.numPoints=0,this.color=new g(0,0,0,1),this.webglNumPoints=0}},m=class extends x{constructor(t,e){super(),this.currentIndex=0,this.webglNumPoints=e,this.numPoints=e,this.color=t,this.xy=new Float32Array(2*this.webglNumPoints)}setX(t,e){this.xy[t*2]=e}setY(t,e){this.xy[t*2+1]=e}getX(t){return this.xy[t*2]}getY(t){return this.xy[t*2+1]}lineSpaceX(t,e){for(let i=0;i<this.numPoints;i++)this.setX(i,t+e*i)}arrangeX(){this.lineSpaceX(-1,2/this.numPoints)}constY(t){for(let e=0;e<this.numPoints;e++)this.setY(e,t)}shiftAdd(t){let e=t.length;for(let i=0;i<this.numPoints-e;i++)this.setY(i,this.getY(i+e));for(let i=0;i<e;i++)this.setY(i+this.numPoints-e,t[i])}addArrayY(t){if(this.currentIndex+t.length<=this.numPoints)for(let e=0;e<t.length;e++)this.setY(this.currentIndex,t[e]),this.currentIndex++}replaceArrayY(t){if(t.length==this.numPoints)for(let e=0;e<this.numPoints;e++)this.setY(e,t[e])}};var L=(a,t,e)=>{let i={x:0,y:0};return i.x=a.x+t.x*e,i.y=a.y+t.y*e,i},v=a=>_(-a.y,a.x),b=(a,t)=>{let e=R(a,t);return e=A(e),e},Y=(a,t)=>{let e={x:0,y:0};return e.x=a.x+t.x,e.y=a.y+t.y,e},M=(a,t)=>a.x*t.x+a.y*t.y,A=a=>{let t={x:0,y:0},e=a.x*a.x+a.y*a.y;return e>0&&(e=1/Math.sqrt(e),t.x=a.x*e,t.y=a.y*e),t},_=(a,t)=>{let e={x:0,y:0};return e.x=a,e.y=t,e},R=(a,t)=>{let e={x:0,y:0};return e.x=a.x-t.x,e.y=a.y-t.y,e},S=a=>{let t,e={x:0,y:0},i={x:0,y:0},r=[],o=(l,h)=>{r.push({vec2:l,miterLength:h})},s=l=>({x:a[l*2],y:a[l*2+1]});e=b(s(1),s(0)),t=v(e),o(t,1);let n=a.length/2;for(let l=1;l<n-1;l++){let h=s(l-1),u=s(l),f=s(l+1);e=b(u,h),t=v(e),i=b(f,u);let d=T(e,i),y=X(e,d,1);o(d,y)}return e=b(s(n-1),s(n-2)),t=v(e),o(t,1),r},T=(a,t)=>{let e=Y(a,t);return e=A(e),_(-e.y,e.x)},X=(a,t,e)=>{let i=_(-a.y,a.x);return e/M(t,i)},p=class extends x{constructor(t,e,i){super(),this.currentIndex=0,this._thicknessRequested=0,this._actualThickness=0,this.webglNumPoints=e*2,this.numPoints=e,this.color=t,this._thicknessRequested=i,this._linePoints=new Float32Array(e*2),this.xy=new Float32Array(2*this.webglNumPoints)}convertToTriPoints(){let t=this._actualThickness/2,e=S(this._linePoints);for(let i=0;i<this.numPoints;i++){let r=this._linePoints[2*i],o=this._linePoints[2*i+1],s={x:r,y:o},n=L(s,e[i].vec2,e[i].miterLength*t),l=L(s,e[i].vec2,-e[i].miterLength*t);this.xy[i*4]=n.x,this.xy[i*4+1]=n.y,this.xy[i*4+2]=l.x,this.xy[i*4+3]=l.y}}setX(t,e){this._linePoints[t*2]=e}setY(t,e){this._linePoints[t*2+1]=e}lineSpaceX(t,e){for(let i=0;i<this.numPoints;i++)this.setX(i,t+e*i)}setThickness(t){this._thicknessRequested=t}getThickness(){return this._thicknessRequested}setActualThickness(t){this._actualThickness=t}},w=class{constructor(t,e){this.debug=!1,this.addLine=this.addDataLine,e==null?this.webgl=t.getContext("webgl",{antialias:!0,transparent:!1}):(this.webgl=t.getContext("webgl",{antialias:e.antialias,transparent:e.transparent,desynchronized:e.deSync,powerPerformance:e.powerPerformance,preserveDrawing:e.preserveDrawing}),this.debug=e.debug==null?!1:e.debug),this.log("canvas type is: "+t.constructor.name),this.log(`[webgl-plot]:width=${t.width}, height=${t.height}`),this._linesData=[],this._linesAux=[],this._thickLines=[],this._surfaces=[],this.gScaleX=1,this.gScaleY=1,this.gXYratio=1,this.gOffsetX=0,this.gOffsetY=0,this.gLog10X=!1,this.gLog10Y=!1,this.webgl.clear(this.webgl.COLOR_BUFFER_BIT),this.webgl.viewport(0,0,t.width,t.height),this._progLine=this.webgl.createProgram(),this.initThinLineProgram(),this.webgl.enable(this.webgl.BLEND),this.webgl.blendFunc(this.webgl.SRC_ALPHA,this.webgl.ONE_MINUS_SRC_ALPHA)}get linesData(){return this._linesData}get linesAux(){return this._linesAux}get thickLines(){return this._thickLines}get surfaces(){return this._surfaces}_drawLines(t){let e=this.webgl;t.forEach(i=>{if(i.visible){e.useProgram(this._progLine);let r=e.getUniformLocation(this._progLine,"uscale");e.uniformMatrix2fv(r,!1,new Float32Array([i.scaleX*this.gScaleX*(this.gLog10X?1/Math.log(10):1),0,0,i.scaleY*this.gScaleY*this.gXYratio*(this.gLog10Y?1/Math.log(10):1)]));let o=e.getUniformLocation(this._progLine,"uoffset");e.uniform2fv(o,new Float32Array([i.offsetX+this.gOffsetX,i.offsetY+this.gOffsetY]));let s=e.getUniformLocation(this._progLine,"is_log");e.uniform2iv(s,new Int32Array([this.gLog10X?1:0,this.gLog10Y?1:0]));let n=e.getUniformLocation(this._progLine,"uColor");e.uniform4fv(n,[i.color.r,i.color.g,i.color.b,i.color.a]),e.bufferData(e.ARRAY_BUFFER,i.xy,e.STREAM_DRAW),e.drawArrays(i.loop?e.LINE_LOOP:e.LINE_STRIP,0,i.webglNumPoints)}})}_drawSurfaces(t){let e=this.webgl;t.forEach(i=>{if(i.visible){e.useProgram(this._progLine);let r=e.getUniformLocation(this._progLine,"uscale");e.uniformMatrix2fv(r,!1,new Float32Array([i.scaleX*this.gScaleX*(this.gLog10X?1/Math.log(10):1),0,0,i.scaleY*this.gScaleY*this.gXYratio*(this.gLog10Y?1/Math.log(10):1)]));let o=e.getUniformLocation(this._progLine,"uoffset");e.uniform2fv(o,new Float32Array([i.offsetX+this.gOffsetX,i.offsetY+this.gOffsetY]));let s=e.getUniformLocation(this._progLine,"is_log");e.uniform2iv(s,new Int32Array([this.gLog10X?1:0,this.gLog10Y?1:0]));let n=e.getUniformLocation(this._progLine,"uColor");e.uniform4fv(n,[i.color.r,i.color.g,i.color.b,i.color.a]),e.bufferData(e.ARRAY_BUFFER,i.xy,e.STREAM_DRAW),e.drawArrays(e.TRIANGLE_STRIP,0,i.webglNumPoints)}})}_drawTriangles(t){let e=this.webgl;e.bufferData(e.ARRAY_BUFFER,t.xy,e.STREAM_DRAW),e.useProgram(this._progLine);let i=e.getUniformLocation(this._progLine,"uscale");e.uniformMatrix2fv(i,!1,new Float32Array([t.scaleX*this.gScaleX*(this.gLog10X?1/Math.log(10):1),0,0,t.scaleY*this.gScaleY*this.gXYratio*(this.gLog10Y?1/Math.log(10):1)]));let r=e.getUniformLocation(this._progLine,"uoffset");e.uniform2fv(r,new Float32Array([t.offsetX+this.gOffsetX,t.offsetY+this.gOffsetY]));let o=e.getUniformLocation(this._progLine,"is_log");e.uniform2iv(o,new Int32Array([0,0]));let s=e.getUniformLocation(this._progLine,"uColor");e.uniform4fv(s,[t.color.r,t.color.g,t.color.b,t.color.a]),e.drawArrays(e.TRIANGLE_STRIP,0,t.xy.length/2)}_drawThickLines(){this._thickLines.forEach(t=>{if(t.visible){let e=Math.min(this.gScaleX,this.gScaleY);t.setActualThickness(t.getThickness()/e),t.convertToTriPoints(),this._drawTriangles(t)}})}update(){this.clear(),this.draw()}draw(){this._drawLines(this.linesData),this._drawLines(this.linesAux),this._drawThickLines(),this._drawSurfaces(this.surfaces)}clear(){this.webgl.clear(this.webgl.COLOR_BUFFER_BIT)}_addLine(t){t._vbuffer=this.webgl.createBuffer(),this.webgl.bindBuffer(this.webgl.ARRAY_BUFFER,t._vbuffer),this.webgl.bufferData(this.webgl.ARRAY_BUFFER,t.xy,this.webgl.STREAM_DRAW),t._coord=this.webgl.getAttribLocation(this._progLine,"coordinates"),this.webgl.vertexAttribPointer(t._coord,2,this.webgl.FLOAT,!1,0,0),this.webgl.enableVertexAttribArray(t._coord)}addDataLine(t){this._addLine(t),this.linesData.push(t)}addAuxLine(t){this._addLine(t),this.linesAux.push(t)}addThickLine(t){this._addLine(t),this._thickLines.push(t)}addSurface(t){this._addLine(t),this.surfaces.push(t)}initThinLineProgram(){let t=`
      attribute vec2 coordinates;
      uniform mat2 uscale;
      uniform vec2 uoffset;
      uniform ivec2 is_log;

      void main(void) {
         float x = (is_log[0]==1) ? log(coordinates.x) : coordinates.x;
         float y = (is_log[1]==1) ? log(coordinates.y) : coordinates.y;
         vec2 line = vec2(x, y);
         gl_Position = vec4(uscale*line + uoffset, 0.0, 1.0);
      }`,e=this.webgl.createShader(this.webgl.VERTEX_SHADER);this.webgl.shaderSource(e,t),this.webgl.compileShader(e);let i=`
         precision mediump float;
         uniform highp vec4 uColor;
         void main(void) {
            gl_FragColor =  uColor;
         }`,r=this.webgl.createShader(this.webgl.FRAGMENT_SHADER);this.webgl.shaderSource(r,i),this.webgl.compileShader(r),this._progLine=this.webgl.createProgram(),this.webgl.attachShader(this._progLine,e),this.webgl.attachShader(this._progLine,r),this.webgl.linkProgram(this._progLine)}popDataLine(){this.linesData.pop()}removeAllLines(){this._linesData=[],this._linesAux=[],this._thickLines=[],this._surfaces=[]}removeDataLines(){this._linesData=[]}removeAuxLines(){this._linesAux=[]}viewport(t,e,i,r){this.webgl.viewport(t,e,i,r)}log(t){this.debug&&console.log("[webgl-plot]:"+t)}};var c=class{constructor(){this.plots={}}initPlot(t,e){if(e||(e=new w(t.canvas,t.webglOptions)),!t._id){t._id=`plot${Math.floor(Math.random()*1e15)}`;let o={plot:e,settings:t};this.plots[t._id]=o}t.overlay&&(typeof t.overlay!="object"&&(t.overlay=document.createElement("canvas"),t.overlay.style.position="absolute",t.overlay.width=t.canvas.width,t.overlay.height=t.canvas.height,t.canvas.appendChild(t.overlay)),t.overlayCtx=t.overlay.getContext("2d"));let i=0,r=Object.keys(t.lines).length;t.nLines=r;for(let o in t.lines){let s=t.lines[o];if(s.color)Array.isArray(s.color)&&(s.color=new g(...s.color));else{let l=c.HSLToRGB(360*(i/r)%360,100,50);s.color=new g(...l,1)}let n;if(s.nPoints?n=s.nPoints:s.nSec&&s.sps?n=Math.ceil(s.nSec*s.sps):s.values&&(n=s.values.length),!n)return;if(s.points=n,s.width?s.line=new p(s.color,n,s.width):s.line=new m(s.color,n),s.line.arrangeX(),s.values){if(t.overlay){let l=Math.max(...s.values),h=Math.min(...s.values);s.ymin=h,s.ymax=l}s.values.length!==n&&(s.interpolate?s.values.length>n?s.values=c.downsample(s.values,n):s.values.length<n&&(s.values=c.upsample(s.values,n)):s.values.length>s.points?s.values=s.values.slice(s.values.length-s.points):s.values=[...new Array(s.points-s.values.length).fill(0),...s.values])}else s.values=new Array(n).fill(0);if("autoscale"in s||(s.autoscale=!0),s.position||(s.position=i),s.autoscale&&(s.values=c.autoscale(s.values,s.position?s.position:i,r,s.centerZero)),s.values.forEach((l,h)=>s.line.setY(h,l)),e.addDataLine(s.line),"xAxis"in s||(s.xAxis=!0),s.xAxis){s.xColor&&(Array.isArray(s.xColor)?s.xColor=new g(...s.xColor):s.xColor=new g(1,1,1,.3));let l=new m(s.xColor,2);s.autoscale?l.constY((i+1)*2/r-1-1/r):l.constY(.5),l.arrangeX(),s.x=l,e.addAuxLine(l)}if(r>1&&s.autoscale&&i!==r-1){t.dividerColor?Array.isArray(t.dividerColor)&&(t.dividerColor=new g(...t.dividerColor)):t.dividerColor=new g(1,1,1,1);let l=new m(t.dividerColor,2);l.constY((i+1)*2/r-1),l.arrangeX(),s.divider=l,e.addAuxLine(l)}i++}return this.plots[t._id]}deinitPlot(t){return typeof t=="string"&&(t=this.plots[t]),t.plot.clear(),t.plot.removeAllLines(),!0}reinitPlot(t,e){return typeof t=="string"&&(t=this.plots[t]),t.plot.clear(),t.plot.removeAllLines(),this.initPlot(e,t.plot)}update(t,e,i=!0){if(typeof t=="string"&&(t=this.plots[t]),!!t){if(e){for(let r in e)if(t.settings.lines[r]){let o=t.settings.lines[r];if(Object.assign(o,e[r]),o.values){if(t.settings.overlay){let s=Math.max(...o.values),n=Math.min(...o.values);o.ymin=n,o.ymax=s}o.values.length!==o.points&&(o.interpolate?o.values.length>o.points?o.values=c.downsample(o.values,o.points):o.values.length<o.points&&(o.values=c.upsample(o.values,o.points)):o.values.length>o.points?o.values=o.values.slice(o.values.length-o.points):o.values=[...new Array(o.points-o.values.length).fill(0),...o.values]),o.autoscale&&(o.values=c.autoscale(o.values,o.position,t.settings.nLines,o.centerZero)),o.values.forEach((s,n)=>o.line.setY(n,s))}}}if(typeof t.settings.overlay=="object"){let r=t.settings.overlay,o=t.settings.overlayCtx;o.clearRect(0,0,t.settings.overlay.width,t.settings.overlay.height),o.font="1em Courier",o.fillStyle="white";for(let s in t.settings.lines){let n=t.settings.lines[s];o.fillText(s,20,r.height*(n.position+.1)/t.settings.nLines),o.fillText(n.ymax,r.width-70,r.height*(n.position+.1)/t.settings.nLines),o.fillText(n.ymin,r.width-70,r.height*(n.position+.9)/t.settings.nLines)}}i&&t.plot.update()}}updateLine(t,e,i,r,o,s,n){return t.numPoints!==e.length&&(i?t.numPoints>e.length?e=c.downsample(e,t.numPoints):t.numPoints<e.length&&(e=c.upsample(e,t.numPoints)):e=e.slice(e.length-t.numPoints)),r&&(e=c.autoscale(e,o,s,n)),e.forEach((l,h)=>t.setY(h,l)),!0}static autoscale(t,e=0,i=1,r=!1){if(t?.length===0)return t;let o=Math.max(...t),s=Math.min(...t),n=1/i,l;if(r){let h=Math.max(Math.abs(s),Math.abs(o));return l=n/h,t.map(u=>u*l+(n*(e+1)*2-1-n))}else return l=n/(o-s),t.map(h=>2*((h-s)*l-1/(2*i))+(n*(e+1)*2-1-n))}static absmax(t){return Math.max(Math.abs(Math.min(...t)),Math.max(...t))}static downsample(t,e,i=1){if(t.length>e){let r=new Array(e),o=t.length/e,s=t.length-1,n=0,l=0;for(let h=o;h<t.length;h+=o){let u=Math.round(h);u>s&&(u=s);for(let f=n;f<u;f++)r[l]+=t[f];r[l]/=(u-n)*i,l++,n=u}return r}else return t}static upsample(t,e,i=1){var r=function(d,y,P){return(d+(y-d)*P)*i},o=new Array(e),s=(t.length-1)/(e-1);o[0]=t[0];for(var n=1;n<e-1;n++){var l=n*s,h=Math.floor(l),u=Math.ceil(l),f=l-h;o[n]=r(t[h],t[u],f)}return o[e-1]=t[t.length-1],o}static HSLToRGB(t,e,i){e/=100,i/=100;let r=(1-Math.abs(2*i-1))*e,o=r*(1-Math.abs(t/60%2-1)),s=i-r/2,n=0,l=0,h=0;return 0<=t&&t<60?(n=r,l=o,h=0):60<=t&&t<120?(n=o,l=r,h=0):120<=t&&t<180?(n=0,l=r,h=o):180<=t&&t<240?(n=0,l=o,h=r):240<=t&&t<300?(n=o,l=0,h=r):300<=t&&t<360&&(n=r,l=0,h=o),n=Math.round((n+s)*255),l=Math.round((l+s)*255),h=Math.round((h+s)*255),[n,l,h]}static circularBuffer(t,e){return e.length<t.length?t.splice(0,t.length-e.length,...t.slice(e.length)).splice(t.length-e.length,t.length,...e):e.length>t.length?t.splice(0,t.length,e.slice(e.length-t.length)):t.splice(0,t.length,...e),t}};})();
